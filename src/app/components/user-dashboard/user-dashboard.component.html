<section class="welcome-banner">
  <div class="welcome-content">
    <div class="avatar">
      <i class="fas fa-user-circle"></i>
    </div>
    <div class="welcome-text">
      <h1>Welcome, <span class="username">{{ profile.username }}</span>!</h1>
      <p>Your personal banking dashboard</p>
    </div>
  </div>
</section>

<div class="dashboard-container">
  <nav class="sidebar" [class.collapsed]="isSidebarCollapsed">
    <button class="sidebar-toggle" (click)="toggleSidebar()">‚ò∞</button>
    <button class="tab-btn" data-icon="üè†" [class.active]="activeTab === 'home'" (click)="activeTab = 'home'">üè† Home</button>
    <button class="tab-btn" data-icon="üìÑ" [class.active]="activeTab === 'documents'" (click)="activeTab = 'documents'">üìÑ Documents</button>
    <button class="tab-btn" data-icon="üë§" [class.active]="activeTab === 'profile'" (click)="activeTab = 'profile'">üë§ Profile</button>
    <button class="tab-btn" data-icon="üí≥" [class.active]="activeTab === 'transactions'" (click)="activeTab = 'transactions'">üí≥ Transactions</button>
    <button class="tab-btn" data-icon="üí∞" [class.active]="activeTab === 'payment'" (click)="activeTab = 'payment'">üí∞ Make Payment</button>
    
    <!-- Salary Tab - Disabled when no employees -->
    <button class="tab-btn" 
            [class.active]="activeTab === 'salary'" 
            [class.disabled]="isSalaryTabDisabled"
            [disabled]="isSalaryTabDisabled"
            (click)="onTabChange('salary')"
            [title]="isSalaryTabDisabled ? 'No employees available for salary disbursement' : ''">
      üíº Salary
    </button>
    
    <button class="tab-btn" data-icon="üë®‚Äçüíº" [class.active]="activeTab === 'employee'"(click)="activeTab = 'employee'">üë®‚Äçüíº Employee</button>
    <button class="tab-btn" data-icon="üìû" [class.active]="activeTab === 'support'" (click)="activeTab = 'support'">üìû Support</button>

    <div class="logout-section">
      <button class="logout-btn" (click)="logout()">üö™ Logout</button>
    </div>
  </nav>

  <section class="content">
    <!-- Home Tab -->
    <div *ngIf="activeTab === 'home'" class="tab-content">
      <h3>Welcome to User Dashboard</h3>
      <p>Here you can manage your banking profile and upload documents.</p>
      <button (click)="goToTransactions()">View All Transactions</button>
    </div>

    <!-- Documents Tab -->
    <div *ngIf="activeTab === 'documents'" class="tab-content">
      <h3>Upload Documents</h3>

      <!-- Upload Section -->
      <div class="upload-section">
        <label>Aadhaar Card:</label>
        <input type="file" accept=".pdf,image/*" (change)="onFileSelected($event, 'aadhaar')" />
        <p *ngIf="aadhaarFile">Selected: {{ aadhaarFile.name }}</p>
      </div>

      <div class="upload-section">
        <label>PAN Card:</label>
        <input type="file" accept=".pdf,image/*" (change)="onFileSelected($event, 'pan')" />
        <p *ngIf="panFile">Selected: {{ panFile.name }}</p>
      </div>

      <button class="upload-btn" (click)="uploadDocuments()">Upload Documents</button>

      <!-- Show number of uploaded documents -->
      <p class="doc-count">Total documents uploaded: {{ documents.length }}</p>

      <!-- Uploaded Documents Table -->
      <h3>Uploaded Documents</h3>
      <table *ngIf="documents.length > 0" class="documents-table">
        <thead>
          <tr>
            <th>File Name</th>
            <th>Type</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let doc of documents">
            <td>{{ doc.fileName }}</td>
            <td>{{ doc.documentType }}</td>
            <td>
              <button (click)="viewDocument(doc.filePath)">View</button>
              <button (click)="downloadDocument(doc.filePath, doc.fileName)">Download</button>
            </td>
          </tr>
        </tbody>
      </table>

      <p *ngIf="documents.length === 0">No documents uploaded yet.</p>
    </div>

    <!-- Profile Tab -->
    <div *ngIf="activeTab === 'profile'" class="tab-content">
      <h3>Profile Details</h3>
      <form (ngSubmit)="updateProfile()" #profileForm="ngForm">
        <label>Username:</label>
        <input
          type="text"
          [(ngModel)]="profile.username"
          name="username"
          required
          [attr.aria-invalid]="!profile.username ? true : null"
        />

        <label>Email:</label>
        <input
          type="email"
          [(ngModel)]="profile.email"
          name="email"
          required
          [attr.aria-invalid]="!profile.email ? true : null"
        />

        <label>Phone Number:</label>
        <input
          type="tel"
          [(ngModel)]="profile.phoneNumber"
          name="phoneNumber"
          required
          [attr.aria-invalid]="!profile.phoneNumber ? true : null"
        />

        <button type="submit">Update Profile</button>
      </form>
    </div>

    <!-- Report Tab -->
    <div *ngIf="activeTab === 'home'" class="tab-content">
      <h3>Report </h3>
      <app-report-component [isAdminView]="false"></app-report-component>
    </div>

    <!-- Transactions Tab -->
    <div *ngIf="activeTab === 'transactions'" class="tab-content" >
      <h3>Recent Transactions</h3>
      <table class="transactions-table">
        <thead>
          <tr>
            <th>Sender</th>
            <th>Receiver</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Type</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let tx of transactions">
            <td>{{ tx.senderName }}</td>
            <td>{{ tx.receiverName }}</td>
            <td>‚Çπ{{ tx.amount }}</td>
            <td>{{ tx.transactionStatus }}</td>
            <td class="transactionType" [ngClass]="{'green-text': tx.transactionType === 'Credit', 'red-text': tx.transactionType == 'Debit'}">
              {{ tx.transactionType }}</td>
            <td>{{ tx.transactionDate | date: 'medium' }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Make Payment Tab -->
    <div *ngIf="activeTab === 'payment'" class="tab-content">
      <h3>Make a Payment</h3>

      <label>Select Beneficiary:</label>
      <select [(ngModel)]="payment.beneficiaryId" (change)="onBeneficiarySelect($event)">
        <option [value]="null" disabled selected>Select beneficiary</option>
        <option *ngFor="let b of beneficiaries" [value]="b.beneficiaryId">
          {{ b.bankName }} - {{ b.accountNo }}
        </option>
      </select>

      <!-- Buttons -->
      <div style="margin: 10px 0; display: flex; gap: 10px;">
        <button (click)="onCreateNewBeneficiary()" class="btn-add">
          + Add New Beneficiary
        </button>
        <button (click)="toggleBeneficiaryList()" class="btn-view">
          üëÅ View My Beneficiaries
        </button>
      </div>

      <!-- Beneficiary List -->
      <div *ngIf="showBeneficiaryList" class="beneficiary-list">
        <div *ngIf="beneficiaries.length === 0" class="no-beneficiaries">
          <p>No beneficiaries found. <a (click)="onCreateNewBeneficiary()" style="color: blue; cursor: pointer;">Create one now</a></p>
        </div>
        
        <table *ngIf="beneficiaries.length > 0">
          <thead>
            <tr>
              <th>Bank Name</th>
              <th>Account No</th>
              <th>IFSC Code</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let b of beneficiaries">
              <td>{{ b.bankName }}</td>
              <td>{{ b.accountNo }}</td>
              <td>{{ b.ifsccode }}</td>
              <td>
                <button (click)="selectedBeneficiary = b; payment.beneficiaryId = b.beneficiaryId" class="btn-select">
                  Select
                </button>
              
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Selected Beneficiary Info -->
      <div *ngIf="selectedBeneficiary" class="selected-beneficiary-box">
        <p><strong>Selected Beneficiary:</strong></p>
        <p><strong>Bank:</strong> {{ selectedBeneficiary.bankName }}</p>
        <p><strong>Account No:</strong> {{ selectedBeneficiary.accountNo }}</p>
        <p><strong>IFSC Code:</strong> {{ selectedBeneficiary.ifsccode || 'na' }}</p>
      </div>

      <label>Amount (‚Çπ):</label>
      <input type="number" [(ngModel)]="payment.amount" placeholder="Enter amount" />

      <label>Remarks:</label>
      <input type="text" [(ngModel)]="payment.remarks" placeholder="Optional" />

      <button (click)="submitPayment()" [disabled]="!selectedBeneficiary || !payment.amount">Pay</button>
    </div>

    <!-- Support Tab -->
    <div *ngIf="activeTab === 'support'" class="tab-content">
      <h3>Contact Support</h3>

      <form (ngSubmit)="submitSupportForm()" #supportForm="ngForm" class="support-form">
        <!-- Name -->
        <label for="name">Name:</label>
        <input
          type="text"
          id="name"
          name="name"
          [(ngModel)]="support.name"
          required
          placeholder="Enter your name"
        />

        <!-- Email -->
        <label for="email">Email:</label>
        <input
          type="email"
          id="email"
          name="email"
          [(ngModel)]="support.email"
          required
          placeholder="Enter your email"
        />

        <!-- Subject -->
        <label for="subject">Subject:</label>
        <select
          id="subject"
          name="subject"
          [(ngModel)]="support.subject"
          required
        >
          <option value="" disabled selected>Select subject</option>
          <option value="bank_issue">Bank related issue</option>
          <option value="profile_issue">Profile related issue</option>
          <option value="fraud">Fraud</option>
          <option value="payment_issue">Payment issue</option>
          <option value="account_issue">Account related issue</option>
          <option value="complaint">Complaint</option>
          <option value="others">Others</option>
        </select>

        <!-- Message -->
        <label for="message">Message:</label>
        <textarea
          id="message"
          name="message"
          [(ngModel)]="support.message"
          required
          rows="5"
          placeholder="Enter your message here"
        ></textarea>

        <button type="submit" [disabled]="!supportForm.form.valid">Submit</button>
      </form>
    </div>

    <!-- Employee Tab -->
    <ng-container *ngIf="(activeTab === 'employee' || activeTab === 'salary') && !employeeDataLoaded">
      {{ loadEmployeesForCurrentClient() }}
    </ng-container>
    <div *ngIf="activeTab === 'employee' && filteredEmployees.length > 0">
      <table class="employee-table">
        <thead>
          <tr>
            <th>Employee ID</th>
            <th>Name</th>
            <th>Bank Name</th>
            <th>Salary</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let emp of filteredEmployees">
            <td>{{ emp.employeeId }}</td>
            <td>{{ emp.employeeName }}</td>
            <td>{{ emp.bankName }}</td>
            <td>{{ emp.salary }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Show if no employees found -->
    <ng-template [ngIf]="filteredEmployees.length === 0 && activeTab === 'employee' && employeeDataLoaded">
      <p>No employees found for the current client.</p>
    </ng-template>

    <!-- Salary Tab -->
    <div *ngIf="activeTab === 'salary'" class="tab-content">
      <h3>Salary Disbursement</h3>
      
      <div *ngIf="filteredEmployees.length === 0" class="no-employees-message" && employeeDataLoaded>
        <p>No employees available for salary disbursement.</p>
        <p>Please add employees first to use this feature.</p>
      </div>
      
      <div *ngIf="filteredEmployees.length > 0">
        <label>Employee:</label>
        <select
          [(ngModel)]="salaryDisbursement.employeeId"
          (ngModelChange)="onEmployeeChange($event)"
        >
          <option [ngValue]="null">-- Select Employee --</option>
          <option
            *ngFor="let employee of filteredEmployees"
            [ngValue]="employee.employeeId"
          >
            {{ employee.employeeName }}
          </option>
        </select>

        <label>Amount:</label>
        <input type="number" [(ngModel)]="salaryDisbursement.amount" name="amount" required readonly />

        <label>Batch ID:</label>
        <input type="number" [(ngModel)]="salaryDisbursement.batchId" name="batchId" required readonly/>

        <button (click)="submitSalaryDisbursement()">Disburse Salary</button>

        <hr />

        <h4>Past Salary Disbursements</h4>

        <table class="past-disbursement-table" *ngIf="paginatedDisbursements.length > 0; else noDisbursements">
          <thead>
            <tr>
              <th>#</th>
              <th>Employee Name</th>
              <th>Client Name</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Date</th>
              <th>Batch ID</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let d of paginatedDisbursements; let i = index">
              <td>{{ (currentPage - 1) * pageSize + i + 1 }}</td>
              <td>{{ d.employeeId }}</td>
              <td>{{ getEmployeeNameById(d.employeeId) }}</td>
              <td>{{ d.amount }}</td>
              <td>{{ d.status }}</td>
              <td>{{ d.date | date: 'mediumDate' }}</td>
              <td>{{ d.batchId }}</td>
            </tr>
          </tbody>
        </table>

        <!-- No records -->
        <ng-template #noDisbursements>
          <p>No past disbursements found.</p>
        </ng-template>

        <!-- Pagination Controls -->
        <div *ngIf="totalPages > 1" class="pagination">
          <button (click)="prevPage()" [disabled]="currentPage === 1">Previous</button>

          <button
            *ngFor="let page of [].constructor(totalPages); let i = index"
            (click)="goToPage(i + 1)"
            [class.active]="currentPage === i + 1"
          >
            {{ i + 1 }}
          </button>

          <button (click)="nextPage()" [disabled]="currentPage === totalPages">Next</button>
        </div>
      </div>
    </div>
  </section>
</div>